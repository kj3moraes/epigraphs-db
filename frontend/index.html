<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Epigraphs Graph</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
    }

    #graph-container {
      width: 100%;
      height: 100%;
    }

    /* Loading overlay */
    #loading-overlay {
      position: fixed;
      inset: 0;
      z-index: 1000;
      background: #0a0a0a;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
      transition: opacity 0.5s ease;
    }
    #loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }
    #loading-overlay h1 {
      font-size: 28px;
      font-weight: 600;
      color: #fff;
    }
    #loading-overlay p {
      font-size: 14px;
      color: #888;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #333;
      border-top-color: #059669;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Top-left info panel (node hover) */
    #node-panel {
      position: fixed;
      top: 20px;
      left: 20px;
      max-width: 340px;
      z-index: 100;
      pointer-events: none;
    }
    #node-panel h2 {
      font-size: 20px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 4px;
    }
    #node-panel h3 {
      font-size: 14px;
      font-weight: 400;
      color: #aaa;
      margin-bottom: 8px;
    }
    #node-panel .meta {
      font-size: 12px;
      color: #777;
      line-height: 1.6;
    }

    /* Bottom-right edge info card */
    #edge-card {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 380px;
      max-height: 50vh;
      overflow-y: auto;
      background: rgba(20, 20, 20, 0.92);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      backdrop-filter: blur(12px);
      padding: 20px;
      z-index: 100;
      display: none;
      font-size: 13px;
      line-height: 1.6;
    }
    #edge-card.visible { display: block; }
    #edge-card .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 14px;
    }
    #edge-card .card-title {
      font-size: 15px;
      font-weight: 600;
      color: #fff;
    }
    #edge-card .close-btn {
      cursor: pointer;
      background: none;
      border: none;
      color: #888;
      font-size: 18px;
      line-height: 1;
      padding: 2px 6px;
      border-radius: 4px;
      pointer-events: all;
    }
    #edge-card .close-btn:hover { color: #fff; background: rgba(255,255,255,0.1); }
    #edge-card .divider {
      height: 1px;
      background: rgba(255,255,255,0.08);
      margin: 12px 0;
    }
    #edge-card .label {
      font-size: 11px;
      font-weight: 500;
      color: #059669;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    #edge-card .value {
      color: #ccc;
      margin-bottom: 10px;
    }
    #edge-card .epigraph-text {
      color: #aaa;
      font-style: italic;
      border-left: 2px solid #059669;
      padding-left: 10px;
      margin: 8px 0;
    }
    #edge-card .arrow-indicator {
      text-align: center;
      color: #059669;
      font-size: 20px;
      margin: 6px 0;
    }

    /* Bottom-left controls */
    #controls-panel {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 100;
      font-size: 11px;
      color: #555;
      line-height: 1.8;
      pointer-events: none;
    }
    #controls-panel .key {
      display: inline-block;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 4px;
      padding: 1px 6px;
      font-size: 10px;
      color: #999;
      font-family: 'Inter', monospace;
      min-width: 20px;
      text-align: center;
    }

    /* Top-right search bar */
    #search-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 100;
      width: 280px;
    }
    #search-input {
      width: 100%;
      padding: 10px 14px;
      background: rgba(20, 20, 20, 0.85);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 10px;
      backdrop-filter: blur(8px);
      color: #fff;
      font-family: 'Inter', sans-serif;
      font-size: 13px;
      outline: none;
      transition: border-color 0.2s;
    }
    #search-input:focus { border-color: #059669; }
    #search-input::placeholder { color: #555; }
    #search-results {
      margin-top: 6px;
      max-height: 240px;
      overflow-y: auto;
      display: none;
    }
    #search-results.visible { display: block; }
    .search-result-item {
      padding: 8px 12px;
      background: rgba(20,20,20,0.9);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 8px;
      margin-bottom: 4px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .search-result-item:hover { background: rgba(40,40,40,0.95); }
    .search-result-item .sr-title {
      font-size: 12px;
      font-weight: 500;
      color: #fff;
    }
    .search-result-item .sr-author {
      font-size: 11px;
      color: #888;
    }

    /* Bottom-right attribution */
    #attribution {
      position: fixed;
      bottom: 6px;
      right: 20px;
      font-size: 10px;
      color: #444;
      z-index: 50;
    }
    #attribution a { color: #666; text-decoration: none; }
    #attribution a:hover { color: #999; }
  </style>
</head>
<body>

  <!-- Loading overlay -->
  <div id="loading-overlay">
    <div class="spinner"></div>
    <h1>Epigraphs Graph</h1>
    <p>Loading graph data…</p>
  </div>

  <!-- Graph container -->
  <div id="graph-container"></div>

  <!-- Node hover panel (top-left) -->
  <div id="node-panel">
    <h2 id="np-default-msg" style="font-size:15px; font-weight:400; color:#666;">
      Hover over a node to see details
    </h2>
  </div>

  <!-- Edge info card (bottom-right) -->
  <div id="edge-card">
    <div class="card-header">
      <div class="card-title">Epigraph Connection</div>
      <button class="close-btn" onclick="closeEdgeCard()">&times;</button>
    </div>
    <div id="edge-card-body"></div>
  </div>

  <!-- Controls (bottom-left) -->
  <div id="controls-panel">
    <div><span class="key">W</span> Forward &nbsp; <span class="key">S</span> Backward</div>
    <div><span class="key">A</span> Left &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="key">D</span> Right</div>
    <div><span class="key">Q</span> Roll CW &nbsp; <span class="key">E</span> Roll CCW</div>
    <div><span class="key">↑↓←→</span> Rotate &nbsp; <span class="key">Mouse</span> Orbit</div>
  </div>

  <!-- Search (top-right) -->
  <div id="search-container">
    <input type="text" id="search-input" placeholder="Search by title or author…" autocomplete="off" />
    <div id="search-results"></div>
  </div>

  <!-- Attribution -->
  <div id="attribution">
    Data from <a href="https://bond-lab.github.io/epigraphs/" target="_blank">Bond Lab Epigraphs Project</a>
  </div>

  <!-- Libraries -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.160.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://unpkg.com/3d-force-graph@1.73.3/dist/3d-force-graph.min.js"></script>

  <script>
    // ─── COLORS ──────────────────────────────────────────────
    const NODE_COLOR       = '#059669';
    const NODE_HOVER_COLOR = '#ffe213';
    const NODE_CONNECTED   = '#e37622';
    const LINK_COLOR       = 'rgba(130, 168, 245, 0.8)';
    const LINK_HOVER_COLOR = '#ffe213';
    const BG_COLOR         = '#0a0a0a';

    // ─── STATE ───────────────────────────────────────────────
    let graphData = null;
    let Graph = null;
    let hoveredNode = null;
    let selectedEdge = null;
    const keysPressed = {};
    const MOVE_SPEED = 3;
    const ROTATE_SPEED = 0.015;
    const ROLL_SPEED = 0.02;

    // ─── LOAD DATA ──────────────────────────────────────────
    fetch('./graphData.json')
      .then(r => r.json())
      .then(data => {
        graphData = data;

        // Build a lookup map for nodes
        const nodeMap = {};
        data.nodes.forEach(n => { nodeMap[n.id] = n; });

        // Build adjacency for hover highlighting
        const adjNodes = {};
        const adjLinks = {};
        data.links.forEach(l => {
          const src = typeof l.source === 'object' ? l.source.id : l.source;
          const tgt = typeof l.target === 'object' ? l.target.id : l.target;
          if (!adjNodes[src]) adjNodes[src] = new Set();
          if (!adjNodes[tgt]) adjNodes[tgt] = new Set();
          adjNodes[src].add(tgt);
          adjNodes[tgt].add(src);
          const key = `${src}__${tgt}`;
          if (!adjLinks[src]) adjLinks[src] = [];
          if (!adjLinks[tgt]) adjLinks[tgt] = [];
          adjLinks[src].push(key);
          adjLinks[tgt].push(key);
        });

        // ─── INIT GRAPH ─────────────────────────────────────
        Graph = ForceGraph3D()
          (document.getElementById('graph-container'))
          .graphData(data)
          .backgroundColor(BG_COLOR)
          .nodeVal(n => Math.max(1, Math.sqrt(n.degree || 1)))
          .nodeColor(n => {
            if (hoveredNode) {
              if (n.id === hoveredNode.id) return NODE_HOVER_COLOR;
              if (adjNodes[hoveredNode.id] && adjNodes[hoveredNode.id].has(n.id)) return NODE_CONNECTED;
            }
            return NODE_COLOR;
          })
          .nodeOpacity(0.9)
          .nodeLabel(n => '')  // We handle our own tooltip
          .linkWidth(2.0)
          .linkOpacity(0.3)
          .linkColor(l => {
            if (hoveredNode) {
              const src = typeof l.source === 'object' ? l.source.id : l.source;
              const tgt = typeof l.target === 'object' ? l.target.id : l.target;
              if (src === hoveredNode.id || tgt === hoveredNode.id) return LINK_HOVER_COLOR;
            }
            return LINK_COLOR;
          })
          .linkDirectionalParticles(l => {
            if (hoveredNode) {
              const src = typeof l.source === 'object' ? l.source.id : l.source;
              const tgt = typeof l.target === 'object' ? l.target.id : l.target;
              if (src === hoveredNode.id || tgt === hoveredNode.id) return 2;
            }
            return 0;
          })
          .linkDirectionalParticleWidth(1.2)
          .linkDirectionalParticleColor(() => NODE_HOVER_COLOR)
          .onNodeHover(node => {
            hoveredNode = node || null;
            document.body.style.cursor = node ? 'pointer' : 'default';
            updateNodePanel(node);
          })
          .onNodeClick(node => {
            if (!node) return;
            // Focus camera on clicked node
            const distance = 200;
            const distRatio = 1 + distance / Math.hypot(node.x, node.y, node.z);
            Graph.cameraPosition(
              { x: node.x * distRatio, y: node.y * distRatio, z: node.z * distRatio },
              node,
              1500
            );
          })
          .onLinkClick(link => {
            selectedEdge = link;
            showEdgeCard(link, nodeMap);
          })
          .warmupTicks(80)
          .cooldownTicks(200)
          .d3AlphaDecay(0.02)
          .d3VelocityDecay(0.3);

        // Adjust force engine
        Graph.d3Force('charge').strength(-30);
        Graph.d3Force('link').distance(60);

        // Hide loading after a delay
        setTimeout(() => {
          document.getElementById('loading-overlay').classList.add('hidden');
        }, 1500);

        // Store nodeMap globally for search
        window._nodeMap = nodeMap;
        window._adjNodes = adjNodes;

        // ─── KEYBOARD CONTROLS ──────────────────────────────
        setupKeyboardControls();

        // ─── SEARCH ─────────────────────────────────────────
        setupSearch(data.nodes);
      })
      .catch(err => {
        console.error('Failed to load graph data:', err);
        document.getElementById('loading-overlay').innerHTML =
          '<h1 style="color:#ef4444">Failed to load data</h1><p style="color:#888">Check console for details</p>';
      });

    // ─── NODE PANEL ─────────────────────────────────────────
    function updateNodePanel(node) {
      const panel = document.getElementById('node-panel');
      const defaultMsg = document.getElementById('np-default-msg');
      if (!node) {
        panel.innerHTML = '<h2 id="np-default-msg" style="font-size:15px;font-weight:400;color:#666;">Hover over a node to see details</h2>';
        return;
      }
      let html = `<h2>${escHtml(node.title)}</h2>`;
      html += `<h3>by ${escHtml(node.author)}</h3>`;
      let meta = [];
      if (node.year) meta.push(`${node.year}`);
      if (node.genre) meta.push(node.genre);
      if (node.country) meta.push(node.country);
      if (node.medium) meta.push(node.medium);
      if (meta.length) html += `<div class="meta">${escHtml(meta.join(' · '))}</div>`;
      html += `<div class="meta" style="margin-top:4px;">Connections: ${node.degree || 0}</div>`;
      panel.innerHTML = html;
    }

    // ─── EDGE CARD ──────────────────────────────────────────
    function showEdgeCard(link, nodeMap) {
      const srcId = typeof link.source === 'object' ? link.source.id : link.source;
      const tgtId = typeof link.target === 'object' ? link.target.id : link.target;
      const srcNode = nodeMap[srcId];
      const tgtNode = nodeMap[tgtId];

      let html = '';

      // Source work (epigraph source)
      html += '<div class="label">Epigraph Source</div>';
      html += `<div class="value"><strong>${escHtml(srcNode?.title || srcId)}</strong><br/>`;
      html += `by ${escHtml(srcNode?.author || 'Unknown')}`;
      if (srcNode?.year) html += ` (${srcNode.year})`;
      html += '</div>';

      if (srcNode?.medium) {
        html += `<div class="value" style="margin-top:-6px;font-size:11px;color:#888;">Medium: ${escHtml(srcNode.medium)}</div>`;
      }
      if (srcNode?.country) {
        html += `<div class="value" style="margin-top:-6px;font-size:11px;color:#888;">Country: ${escHtml(srcNode.country)}</div>`;
      }

      html += '<div class="arrow-indicator">↓</div>';

      // Target work (contains the epigraph)
      html += '<div class="label">Referenced By</div>';
      html += `<div class="value"><strong>${escHtml(tgtNode?.title || tgtId)}</strong><br/>`;
      html += `by ${escHtml(tgtNode?.author || 'Unknown')}`;
      if (tgtNode?.year) html += ` (${tgtNode.year})`;
      html += '</div>';

      if (tgtNode?.genre) {
        html += `<div class="value" style="margin-top:-6px;font-size:11px;color:#888;">Genre: ${escHtml(tgtNode.genre)}</div>`;
      }
      if (tgtNode?.country) {
        html += `<div class="value" style="margin-top:-6px;font-size:11px;color:#888;">Nationality: ${escHtml(tgtNode.country)}</div>`;
      }

      // Epigraph text
      if (link.epigraph) {
        html += '<div class="divider"></div>';
        html += '<div class="label">Epigraph Text</div>';
        html += `<div class="epigraph-text">"${escHtml(link.epigraph)}"</div>`;
      }

      if (link.emedium) {
        html += `<div class="value" style="font-size:11px;color:#888;margin-top:6px;">Medium: ${escHtml(link.emedium)}</div>`;
      }

      document.getElementById('edge-card-body').innerHTML = html;
      document.getElementById('edge-card').classList.add('visible');
    }

    function closeEdgeCard() {
      document.getElementById('edge-card').classList.remove('visible');
      selectedEdge = null;
    }

    // ─── KEYBOARD CONTROLS (WASD + QE + Arrows) ────────────
    function setupKeyboardControls() {
      document.addEventListener('keydown', e => {
        // Don't capture when typing in search
        if (e.target.tagName === 'INPUT') return;
        keysPressed[e.key.toLowerCase()] = true;
      });
      document.addEventListener('keyup', e => {
        keysPressed[e.key.toLowerCase()] = false;
      });

      function animateControls() {
        if (!Graph) { requestAnimationFrame(animateControls); return; }

        const camera = Graph.camera();
        const controls = Graph.controls();
        if (!camera) { requestAnimationFrame(animateControls); return; }

        // Get camera's local direction vectors
        const forward = new THREE.Vector3();
        camera.getWorldDirection(forward);
        const right = new THREE.Vector3();
        right.crossVectors(forward, camera.up).normalize();
        const up = camera.up.clone().normalize();

        // WASD movement
        if (keysPressed['w']) {
          camera.position.addScaledVector(forward, MOVE_SPEED);
          if (controls?.target) controls.target.addScaledVector(forward, MOVE_SPEED);
        }
        if (keysPressed['s']) {
          camera.position.addScaledVector(forward, -MOVE_SPEED);
          if (controls?.target) controls.target.addScaledVector(forward, -MOVE_SPEED);
        }
        if (keysPressed['a']) {
          camera.position.addScaledVector(right, -MOVE_SPEED);
          if (controls?.target) controls.target.addScaledVector(right, -MOVE_SPEED);
        }
        if (keysPressed['d']) {
          camera.position.addScaledVector(right, MOVE_SPEED);
          if (controls?.target) controls.target.addScaledVector(right, MOVE_SPEED);
        }

        // Q/E for roll (rotate around forward axis)
        if (keysPressed['q']) {
          camera.rotateOnAxis(new THREE.Vector3(0, 0, 1), ROLL_SPEED);
        }
        if (keysPressed['e']) {
          camera.rotateOnAxis(new THREE.Vector3(0, 0, 1), -ROLL_SPEED);
        }

        // Arrow keys for rotation (orbit-style)
        if (keysPressed['arrowup']) {
          if (controls?.target) {
            const offset = camera.position.clone().sub(controls.target);
            const axis = right;
            offset.applyAxisAngle(axis, -ROTATE_SPEED);
            camera.position.copy(controls.target).add(offset);
            camera.lookAt(controls.target);
          }
        }
        if (keysPressed['arrowdown']) {
          if (controls?.target) {
            const offset = camera.position.clone().sub(controls.target);
            const axis = right;
            offset.applyAxisAngle(axis, ROTATE_SPEED);
            camera.position.copy(controls.target).add(offset);
            camera.lookAt(controls.target);
          }
        }
        if (keysPressed['arrowleft']) {
          if (controls?.target) {
            const offset = camera.position.clone().sub(controls.target);
            offset.applyAxisAngle(up, ROTATE_SPEED);
            camera.position.copy(controls.target).add(offset);
            camera.lookAt(controls.target);
          }
        }
        if (keysPressed['arrowright']) {
          if (controls?.target) {
            const offset = camera.position.clone().sub(controls.target);
            offset.applyAxisAngle(up, -ROTATE_SPEED);
            camera.position.copy(controls.target).add(offset);
            camera.lookAt(controls.target);
          }
        }

        requestAnimationFrame(animateControls);
      }

      animateControls();
    }

    // ─── SEARCH ─────────────────────────────────────────────
    function setupSearch(nodes) {
      const input = document.getElementById('search-input');
      const resultsEl = document.getElementById('search-results');
      let debounce = null;

      input.addEventListener('input', () => {
        clearTimeout(debounce);
        debounce = setTimeout(() => {
          const q = input.value.trim().toLowerCase();
          if (q.length < 2) {
            resultsEl.classList.remove('visible');
            resultsEl.innerHTML = '';
            return;
          }
          const matches = nodes.filter(n =>
            (n.title && n.title.toLowerCase().includes(q)) ||
            (n.author && n.author.toLowerCase().includes(q))
          ).slice(0, 15);

          if (matches.length === 0) {
            resultsEl.innerHTML = '<div style="padding:10px;color:#666;font-size:12px;">No results found</div>';
          } else {
            resultsEl.innerHTML = matches.map(n => `
              <div class="search-result-item" data-id="${escAttr(n.id)}">
                <div class="sr-title">${escHtml(n.title)}</div>
                <div class="sr-author">${escHtml(n.author)}${n.year ? ' · ' + n.year : ''}</div>
              </div>
            `).join('');

            resultsEl.querySelectorAll('.search-result-item').forEach(el => {
              el.addEventListener('click', () => {
                const nodeId = el.getAttribute('data-id');
                const node = graphData.nodes.find(n => n.id === nodeId);
                if (node && Graph) {
                  // Find the rendered node to get position
                  const gd = Graph.graphData();
                  const rNode = gd.nodes.find(n => n.id === nodeId);
                  if (rNode) {
                    const distance = 200;
                    const distRatio = 1 + distance / Math.hypot(rNode.x || 0, rNode.y || 0, rNode.z || 0);
                    Graph.cameraPosition(
                      { x: (rNode.x||0) * distRatio, y: (rNode.y||0) * distRatio, z: (rNode.z||0) * distRatio },
                      rNode,
                      1500
                    );
                    hoveredNode = rNode;
                    updateNodePanel(rNode);
                  }
                }
                resultsEl.classList.remove('visible');
                input.value = '';
              });
            });
          }
          resultsEl.classList.add('visible');
        }, 200);
      });

      // Close results on outside click
      document.addEventListener('click', e => {
        if (!e.target.closest('#search-container')) {
          resultsEl.classList.remove('visible');
        }
      });

      // Prevent keyboard controls when typing
      input.addEventListener('keydown', e => { e.stopPropagation(); });
    }

    // ─── UTILS ──────────────────────────────────────────────
    function escHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }
    function escAttr(str) {
      return escHtml(str).replace(/'/g, '&#39;');
    }
  </script>
</body>
</html>
